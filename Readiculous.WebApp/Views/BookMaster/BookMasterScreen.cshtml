@model IEnumerable<Readiculous.Services.ServiceModels.BookListItemViewModel>
@{
    ViewData["Title"] = "Book Management";
    var selectedGenres = ViewBag.Genres as List<Readiculous.Services.ServiceModels.GenreViewModel>;
}

@section Styles {
    <link href="~/css/book-master.css" rel="stylesheet" asp-append-version="true" />
    <link href="~/css/book-master-modal.css" rel="stylesheet" />
}

<div class="container-fluid px-0 book-management-container">
    <div class="row mb-4 mx-0 align-items-center book-management-header">
        <div class="col-md-6 px-0">
            <h1 class="mb-0 book-management-title">Book Management</h1>
        </div>
        <div class="col-md-6 px-0 text-md-end">
            <button type="button" class="btn btn-success btn-add-book">
                <i class="fas fa-plus me-2"></i>Add Book
            </button>
        </div>
    </div>

    <!-- Search and Filter Form -->
    <form asp-action="BookMasterScreen" method="get" class="mb-4 book-filter-controls" id="bookFilterForm">
        <div class="row g-3 align-items-end mx-0">
            <!-- Search Book Title -->
            <div class="col-md-3 px-0 pe-md-2 filter-group">
                <label for="searchString" class="form-label filter-label">Search Book Title:</label>
                <input type="text" name="searchString" class="form-control filter-input" placeholder="Enter book title"
                       value="@ViewData["CurrentFilter"]" />
            </div>

            <!-- Search Type -->
            <div class="col-md-3 px-0 pe-md-2 filter-group">
                <label for="searchType" class="form-label filter-label">Search Type:</label>
                <select name="searchType" class="form-select filter-input" asp-items="@ViewBag.BookSearchTypes"></select>
            </div>

            <!-- Filter by Genre -->
            <div class="col-md-3 px-0 pe-md-2 filter-group">
                <label for="genreFilter" class="form-label filter-label">Filter by Genre:</label>
                <select name="genreFilter" class="form-select filter-input" asp-items="@ViewBag.GenreList">
                    <option value="">All Genres</option>
                </select>
            </div>

            <!-- Sort By -->
            <div class="col-md-3 px-0 pe-md-2 filter-group">
                <label for="sortOrder" class="form-label filter-label">Sort By:</label>
                <select name="sortOrder" class="form-select filter-input" asp-items="@ViewBag.BookSortTypes"></select>
            </div>
        </div>

        <!-- Genre checkboxes -->
        @if (ViewBag.AllGenres is List<Readiculous.Services.ServiceModels.GenreViewModel> allGenres && allGenres.Any())
        {
            var selectedGenreIds = ViewBag.SelectedGenreIds as List<string> ?? new List<string>();

            <div class="mb-3 mt-3">
                <label class="form-label filter-label">Filter by Genre:</label>
                <div class="row">
                    @for (int i = 0; i < allGenres.Count; i++)
                    {
                        var genre = allGenres[i];
                        var isChecked = selectedGenreIds.Contains(genre.GenreId);

                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" name="selectedGenreIds" value="@genre.GenreId"
                                       class="form-check-input" @(isChecked ? "checked" : "") />
                                <label class="form-check-label">@genre.Name</label>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </form>

    <div class="row mx-0">
        <div class="col px-0 book-table-container">
            <div id="bookListContainer" class="table-responsive">
                @await Html.PartialAsync("_BookListPartial", Model)
            </div>
        </div>
    </div>

    <div class="row mx-0 mt-3 pagination-controls">
        <div class="col-md-6 px-0 text-md-end">
            @if (ViewBag.PaginationModel != null)
            {
                @await Component.InvokeAsync("Pagination", ViewBag.PaginationModel)
            }
        </div>
        <div class="col-md-6 px-0">
            @await Component.InvokeAsync("PageSize", new { currentPageSize = ViewBag.PageSize ?? 10 })
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade book-modal" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="addBookModalBody">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade book-modal" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="editBookModalBody">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade book-modal" id="viewBookModal" tabindex="-1" aria-labelledby="viewBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="viewBookModalBody">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("~/Views/Shared/_DeleteModal.cshtml")

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        var bookMasterSettings = {
            bookMasterScreenUrl: '@Url.Action("BookMasterScreen", "BookMaster")',
            bookAddModalUrl: '@Url.Action("BookAddModal", "BookMaster")',
            bookEditModalUrl: '@Url.Action("BookEditModal", "BookMaster")',
            bookViewModalUrl: '@Url.Action("BookViewModal", "BookMaster")',
            deleteBookUrl: '@Url.Action("Delete", "BookMaster")'
        };
    </script>
    <script src="~/js/adminBookMaster/bookmasterScreen.js" asp-append-version="true"></script>
}
